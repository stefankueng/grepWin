<?xml version="1.0" encoding="Windows-1252"?>

<!-- Align to vcproj defined: x64, Win32 and etc. -->
<?ifndef Platform?>
  <?define Platform = "x64" ?>
<?endif?>

<?define UpgradeCode32 = "C8EC878C-5B8A-4208-9670-64313B180089" ?>
<?define UpgradeCode64 = "C73ED533-953E-47E5-9A42-A48292BB7C6C" ?>

<?if $(var.Platform) = "x64" ?>
  <?define UpgradeCode = "$(var.UpgradeCode64)" ?>
  <?define MainEXEGuid = "6EB3126A-B40B-43D8-96A7-8C171591E01F" ?>
  <?define ShortCutGuid = "83F25E6F-0EE0-4ca8-BF92-FCAD9709037E" ?>
  <?define Win64YesNo = "yes" ?>
  <?define MsiPlatform = "x64" ?>
  <?define Name = "grepWin x64" ?>
  <?define Description = "Stefans grepWin x64" ?>
  <?define PFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
  <?define UpgradeCode = "$(var.UpgradeCode32)" ?>
  <?define MainEXEGuid = "A9818B4B-B626-4455-AA31-588EAFAFA213" ?>
  <?define ShortCutGuid = "5760DCF9-B699-436c-8F8C-C7469630C0ED" ?>
  <?define Win64YesNo = "no" ?>
  <?define MsiPlatform = "x86" ?>
  <?define Name = "grepWin" ?>
  <?define Description = "Stefans grepWin" ?>
  <?define PFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!-- This gets automatically generated by the makefile running SubWCRev.exe on VersionNumberInclude.in.wxi -->
  <?include VersionNumberInclude.wxi ?>

  <Product
    UpgradeCode="$(var.UpgradeCode)"
    Name="$(var.Name)"
    Id="*"
    Language="1033"
    Codepage="1252"
    Version="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)"
    Manufacturer="Stefans Tools">

    <Package Id="*"
             Keywords="Installer"
             Description="$(var.Description)"
             Comments="https://tools.stefankueng.com"
             Manufacturer="Stefans Tools"
             InstallerVersion="200"
             Platform="$(var.MsiPlatform)"
             Languages="1033"
             Compressed="yes"
             SummaryCodepage="1252" />

<!-- Cross bits -->
<?if $(var.Platform) = "x64" ?>
    <Upgrade Id="$(var.UpgradeCode32)" >
      <UpgradeVersion Property="V32INSTALLED" Minimum="0.0.0" />
    </Upgrade>
    <Condition Message="This application requires an 64-bit OS">VersionNT64</Condition>
<?else ?>
    <!-- Replacing each other is  error-prone. -->
    <Upgrade Id="$(var.UpgradeCode64)" >
      <UpgradeVersion Property="V64INSTALLED" Minimum="0.0.0" />
    </Upgrade>
<!--    <Condition Message="Do not install 32-bit version on a 64-bit Windows~">NOT VersionNT64</Condition>-->
    <Condition Message="This application only runs on Windows 7 and later.">
      <![CDATA[Installed OR (VersionNT >= 601)]]>
    </Condition>
<?endif ?>

    <Upgrade Id="$(var.UpgradeCode)" >
      <UpgradeVersion Property="PREVIOUSVERSIONSINSTALLED" Maximum="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)" IncludeMaximum="no" />
    </Upgrade>

    <Media Id="1" Cabinet="grepWin.cab" EmbedCab="yes" CompressionLevel="high" />
    <Icon Id="grepWinIcon" SourceFile="..\Resources\grepWin.ico" />
    <Property Id="ARPPRODUCTICON">grepWinIcon</Property>

    <!-- WixUI_Advanced requires: APPLICATIONFOLDER, ApplicationFolderName and WixAppFolder. -->
    <Property Id="ApplicationFolderName" Value="grepWin" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="$(var.PFilesFolder)" Name="PFiles">
        <Directory Id="APPLICATIONFOLDER" Name="grepWin">

          <Component Id="MainEXE" Guid="$(var.MainEXEGuid)" Win64="$(var.Win64YesNo)">
<?if $(var.Platform) = "x64" ?>
            <File Id="grepWin.exe" Name="grepWin.exe" DiskId="1" Source="../../bin/release64/grepWin.exe" Vital="yes" />
            <File Id="package.msix" Name="package.msix" DiskId="1" Source="../../bin/release64/package.msix" Vital="yes" />
            <File Id="shelldll" Name="ExplorerCommandVerb.dll" DiskId="1" Source="../../bin/release64/ExplorerCommandVerb.dll" Vital="yes" />
<?else ?>
            <File Id="grepWin.exe" Name="grepWin.exe" DiskId="1" Source="../../bin/release/grepWin.exe" Vital="yes" />
<?endif ?>
            <File Id="Afrikaans.lang" Name="Afrikaans.lang" DiskId="1" Source="../../translations/Afrikaans.lang" />
            <File Id="Belarusian.lang" Name="Belarusian.lang" DiskId="1" Source="../../translations/Belarusian.lang" />
            <File Id="ChineseSimplified.lang" Name="Chinese Simplified.lang" DiskId="1" Source="../../translations/Chinese Simplified.lang" />
            <File Id="ChineseTraditional.lang" Name="Chinese Traditional.lang" DiskId="1" Source="../../translations/Chinese Traditional.lang" />
            <File Id="Dutch.lang" Name="Dutch.lang" DiskId="1" Source="../../translations/Dutch.lang" />
            <File Id="French.lang" Name="French.lang" DiskId="1" Source="../../translations/French.lang" />
            <File Id="German.lang" Name="German.lang" DiskId="1" Source="../../translations/German.lang" />
            <File Id="Greek.lang" Name="Greek.lang" DiskId="1" Source="../../translations/Greek.lang" />
            <File Id="Hindi.lang" Name="Hindi.lang" DiskId="1" Source="../../translations/Hindi.lang" />
            <File Id="Hungarian.lang" Name="Hungarian.lang" DiskId="1" Source="../../translations/Hungarian.lang" />
            <File Id="Italian.lang" Name="Italian.lang" DiskId="1" Source="../../translations/Italian.lang" />
            <File Id="Japanese.lang" Name="Japanese.lang" DiskId="1" Source="../../translations/Japanese.lang" />
            <File Id="Korean.lang" Name="Korean.lang" DiskId="1" Source="../../translations/Korean.lang" />
            <File Id="Polish.lang" Name="Polish.lang" DiskId="1" Source="../../translations/Polish.lang" />
            <File Id="Portuguese.lang" Name="Portuguese.lang" DiskId="1" Source="../../translations/Portuguese.lang" />
            <File Id="Portuguese_Brazilian.lang" Name="Portuguese Brazilian.lang" DiskId="1" Source="../../translations/Portuguese Brazilian.lang" />
            <File Id="Russian.lang" Name="Russian.lang" DiskId="1" Source="../../translations/Russian.lang" />
            <File Id="Slovak.lang" Name="Slovak.lang" DiskId="1" Source="../../translations/Slovak.lang" />
            <File Id="Spanish.lang" Name="Spanish.lang" DiskId="1" Source="../../translations/Spanish.lang" />
            <File Id="Spanish_Mexican.lang" Name="Spanish Mexican.lang" DiskId="1" Source="../../translations/Spanish Mexican.lang" />
            <File Id="Swedish.lang" Name="Swedish.lang" DiskId="1" Source="../../translations/Swedish.lang" />
            <File Id="Turkish.lang" Name="Turkish.lang" DiskId="1" Source="../../translations/Turkish.lang" />

<?foreach it in Directory;Directory\Background;LibraryFolder\background;Folder;Drive;*?>
            <RegistryKey Root="HKMU" Key="Software\Classes\$(var.it)\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\$(var.it)\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\$(var.it)\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\$(var.it)\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%1"' Type="string" />
<?endforeach?>
            <RegistryValue Root="HKMU" Key="Software\Classes\*\shell\grepWin" Name="MultiSelectModel" Value='Player' Type="string" />

            <RegistryValue Root="HKMU" Key="Software\grepWin" Name="APPLICATIONFOLDER" Value='[APPLICATIONFOLDER]' Type="string" />

            <RegistryKey Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\grepWin.exe" />
            <RegistryValue Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\grepWin.exe" Name="Path" Value="[APPLICATIONFOLDER]" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\grepWin.exe" Value="[APPLICATIONFOLDER]grepWin.exe" Type="string" />
          </Component>

        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramMenuDir" Name="grepWin">
          <Component Id="StartMenuShortCut" Guid="$(var.ShortCutGuid)" Win64="$(var.Win64YesNo)">
            <Shortcut Id="startMenugrepWin" Directory="ProgramMenuDir" Name="grepWin" Target="[APPLICATIONFOLDER]grepWin.exe" Description="regular expression search" />
            <RemoveFolder Id="ProgramMenuDir" On="uninstall"/>
            <RegistryValue Root="HKMU" Key="Software\grepWin" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="Complete" Title="grepWin" Description="The complete package."
          Display="expand" Level="1" ConfigurableDirectory="APPLICATIONFOLDER">
      <Feature Id="MainEXE" Title="Program" Description="The main executable." Level="1">
        <ComponentRef Id="MainEXE" />
        <ComponentRef Id="StartMenuShortCut" />
      </Feature>
    </Feature>

    <UIRef Id="WixUI_ErrorProgressText" />
    <UIRef Id="WixUI_Advanced" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="Banner.jpg" />
    <WixVariable Id="WixUIDialogBmp" Value="Dialog.jpg" />


<?if $(var.Platform) = "x64" ?>
    <!-- properties for the custom actions to (un)register the sparse package -->
    <Property Id="SPARSEPACKAGEFILE" Value="package.msix"  Secure="yes"/>
    <Property Id="SPARSEPACKAGENAME" Value="7BE7C3C4-6740-4AB4-9C5B-DD64067515BF" Secure="yes"/>

    <Binary Id="CustomActions.dll"  SourceFile="../../bin/release64/CustomActions.dll" />
    <CustomAction Id="RegisterSparsePackage" BinaryKey="CustomActions.dll" DllEntry="RegisterSparsePackage"/>
    <CustomAction Id="UnregisterSparsePackage" BinaryKey="CustomActions.dll" DllEntry="UnregisterSparsePackage"/>

    <!-- msiexec does not have a manifest, so it always reports the version of system dlls as
         for Win7 (6.3.x.x). So we check for 6.3 but use the build number to actually check
         for Win11 -->
    <Property Id="WIN11FOUND" Secure="yes">
      <DirectorySearch Id="searchSystem" Path="[System64Folder]" AssignToProperty="yes">
        <FileSearch Id="searchFile" Name="shell32.dll" MinVersion="6.3.21999.0"/>
      </DirectorySearch>
    </Property>
<?endif ?>

    <!-- ALLUSERS for new installation `FindRelatedProducts`:
         https://learn.microsoft.com/en-us/windows/win32/msi/allusers
         https://learn.microsoft.com/en-us/windows/win32/msi/installation-context -->
    <!-- Prefer default installation type as per-user to per-machine. -->
    <!-- ALLUSERS = "" -->
    <!-- WixUI_Advanced, existing installation -->
    <Property Id="WixAppFolder" Value="WixPerUserFolder" />

    <!-- AppSearch -->
    <!-- Cross permissions test. Prefer the last installation type. Detect first. -->
    <Property Id="LASTPERMACHINEFOLDER" Secure="yes">
      <RegistrySearch Id="FindPerMachineLocation" Root="HKLM" Key="Software\grepWin" Name="APPLICATIONFOLDER" Type="raw" Win64="$(var.Win64YesNo)" />
    </Property>
    <!-- cross bits test -->
<?if $(var.Platform) = "x64" ?>
    <Property Id="LASTPERMACHINEFOLDERCROSS" Secure="yes">
      <RegistrySearch Id="FindPerMachineLocationCross" Root="HKLM" Key="Software\grepWin" Name="APPLICATIONFOLDER" Type="raw" Win64="no" />
    </Property>
<?else ?>
    <Property Id="LASTPERMACHINEFOLDERCROSS" Secure="yes">
      <RegistrySearch Id="FindPerMachineLocationCross" Root="HKLM" Key="Software\grepWin" Name="APPLICATIONFOLDER" Type="raw" Win64="yes" />
    </Property>
<?endif ?>
    <SetProperty Id="LASTPERMACHINEFOLDER" Value="[LASTPERMACHINEFOLDERCROSS]" Before="SetALLUSERS">LASTPERMACHINEFOLDERCROSS</SetProperty>
    <!-- Dynamically set `ALLUSERS` before `FindRelatedProducts` for better matching, to keep only one instance! Overwrite CLI `ALLUSERS`. -->
    <SetProperty Id="ALLUSERS" Value="1" After="AppSearch">LASTPERMACHINEFOLDER</SetProperty>
    <!-- Set in case of skipping WixUI_Advanced, value can be:
         1. CLI APPLICATIONFOLDER,
         2. user chose a new APPLICATIONFOLDER in child InstallDirDlg,
         3. the last customized path for per-machine. -->
    <SetProperty Id="APPLICATIONFOLDER" Value="[LASTPERMACHINEFOLDER]" After="AppSearch">NOT APPLICATIONFOLDER</SetProperty>
    <!-- WixUI_Advanced, existing installation -->
    <SetProperty Id="WixAppFolder" Value="WixPerMachineFolder" After="AppSearch">LASTPERMACHINEFOLDER</SetProperty>

    <!-- Tweak WixUI_Advanced's default APPLICATIONFOLDER -->
    <!-- Per-user, solid path, overwrite [LocalAppDataFolder]Apps\[ApplicationFolderName], Apps for UWP -->
    <CustomAction Id="Overwrite_WixDefaultPerUserFolder" Property="WixPerUserFolder" Value="[LocalAppDataFolder]Programs\[ApplicationFolderName]" Execute="immediate" />
    <InstallExecuteSequence>
      <Custom Action="Overwrite_WixDefaultPerUserFolder" After="WixSetDefaultPerUserFolder" />
    </InstallExecuteSequence>
    <InstallUISequence>
      <Custom Action="Overwrite_WixDefaultPerUserFolder" After="WixSetDefaultPerUserFolder" />
    </InstallUISequence>
    <!-- Per-machine, overwrite [ProgramFilesFolder][ApplicationFolderName] of WixUI_Advanced -->
    <CustomAction Id="Overwrite_WixDefaultPerMachineFolderO" Property="WixPerMachineFolder" Value="[LASTPERMACHINEFOLDER]" Execute="immediate" />
    <CustomAction Id="Overwrite_WixDefaultPerMachineFolderN" Property="WixPerMachineFolder" Value="[$(var.PFilesFolder)][ApplicationFolderName]" Execute="immediate" />
    <InstallExecuteSequence>
      <Custom Action="Overwrite_WixDefaultPerMachineFolderO" After="WixSetDefaultPerMachineFolder">LASTPERMACHINEFOLDER</Custom>
      <Custom Action="Overwrite_WixDefaultPerMachineFolderN" After="WixSetDefaultPerMachineFolder">NOT LASTPERMACHINEFOLDER</Custom>
    </InstallExecuteSequence>
    <InstallUISequence>
      <Custom Action="Overwrite_WixDefaultPerMachineFolderO" After="WixSetDefaultPerMachineFolder">LASTPERMACHINEFOLDER</Custom>
      <Custom Action="Overwrite_WixDefaultPerMachineFolderN" After="WixSetDefaultPerMachineFolder">NOT LASTPERMACHINEFOLDER</Custom>
    </InstallUISequence>

    <SetProperty Id="ARPINSTALLLOCATION" Value="[APPLICATIONFOLDER]" After="CostFinalize" />

    <!-- Make sure in order: `AppSearch` ==> Set`ALLUSERS` ==> `FindRelatedProducts`
         `FindRelatedProducts` runs only once at either place:
         https://learn.microsoft.com/en-us/windows/win32/msi/findrelatedproducts-action -->
    <InstallExecuteSequence>
      <AppSearch Sequence="1" />
      <LaunchConditions After="AppSearch" />
      <RemoveExistingProducts After="InstallValidate">PREVIOUSVERSIONSINSTALLED OR V32INSTALLED OR V64INSTALLED</RemoveExistingProducts>
<?if $(var.Platform) = "x64" ?>
      <Custom Action="RegisterSparsePackage" After="InstallFinalize">NOT (REMOVE~="ALL") AND (NOT WIN11FOUND="")</Custom>
      <Custom Action="UnregisterSparsePackage" Before="RemoveFiles">(REMOVE~="ALL") AND (NOT WIN11FOUND="")</Custom>
<?endif ?>
    </InstallExecuteSequence>
    <InstallUISequence>
      <AppSearch Before="FindRelatedProducts" />
    </InstallUISequence>

  </Product>
</Wix>
